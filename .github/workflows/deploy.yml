name: Deploy
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '12.13.0'

      - name: Install specific npm version
        run: npm install --global npm@6.12.0

      - name: Check out repository
        uses: actions/checkout@v1

      - name: Install dependencies
        run: npm ci

      - name: Build website
        run: npm run build

      - name: Authenticate into Google Cloud Platform
        uses: actions/gcloud/auth@master
        env:
          GCLOUD_AUTH: ${{ secrets.GCLOUD_AUTH }}

      - name: Set up gsutil
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          apt-get install apt-transport-https ca-certificates
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install google-cloud-sdk
          gcloud init
          gcloud config set project ${{ secrets.GCLOUD_PROJECT }}

      - name: Upload to Google Cloud Storage
        run: gsutil -m cp -r -z "css,html,js" dist/* ${{ secrets.GSUTIL_BUCKET_LINK }}/_www
